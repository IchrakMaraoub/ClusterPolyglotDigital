{% extends "web/app/app_base.html" %}
{% load i18n %}
{% load static %}
{% block app %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bootstrap CRUD Data Table for Database with Modal Form</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplelightbox@2.7.0/dist/simple-lightbox.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.1.0/simple-lightbox.min.js"></script>


<h1 class="pg-title">
  <i class="fa fa-list-alt" aria-hidden="true"></i>
  {% translate "Overview Report" %}
</h1>

<div class="container-fluid py-4">
<div class="row mb-4">

        
<div class="col-lg-8 col-md-6 mb-md-0 mb-4">
<div class="card">
<div class="card-header pb-0">
  <h1 class="pg-title">
    <i class="fa fa-bar-chart" aria-hidden="true"></i>
    {% translate "Pareto Chart" %}
  </h1>
    
       
    </div>
    
    
      <div class="pg-content">

      <div class="container">
        <div class="row">
          <div class="col-lg-6 col-7">
            <h6 style="margin-top : 15px;" >Filter</h6>
            <p class="text-sm mb-0"></div>    
            <form id="filter-form-pareto">
              {% csrf_token %}
              <div class="row">
                
                <div class="col-md-3 mb-2">
                  <div class="form-group">
                    <label for="user_chart">User:</label>
                    <select class="form-control" id="user_chart_pareto" name="user_chart_pareto">
                      <option value="">----</option>
                      {% for val_chart_user in users %}
                        <option value="{{ val_chart_user.email }}">{{ val_chart_user.email }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>

                <div class="col-md-3 mb-2">
                  <div class="form-group">
                    <label for="product_chart_pareto">Product Name:</label>
                    <select class="form-control" id="product_chart_pareto" name="product_chart_pareto">
                      <option value="">----</option>
                      {% for val_char_product in products %}
                        <option value="{{ val_char_product }}">{{ val_char_product }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>

                

                <div class="col-md-3 mb-2">
                  <div class="form-group">
                    <label for="start_date_chart">Start Date:</label>
                    <input type="date" class="form-control" id="start_date_chart_pareto" name="start_date_chart_pareto" autocomplete="off">
                  </div>
                </div>
                <div class="col-md-3 mb-2">
                  <div class="form-group">
                    <label for="end_date">End Date:</label>
                    <input type="date" class="form-control" id="end_date_chart_pareto" name="end_date_chart_pareto" autocomplete="off">
                  </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <div class="form-group">
                    <button type="button" class="btn btn-primary mr-3" id="filter-button-pareto"> Filter</button>
                  </div>
                  <div class="form-group">

                    <button type="button" class="btn btn-secondary" id="reset-chart-pareto" style="display: inline-block; margin-left: 15px">Reset</button>
                  </div>
                </div>
              </div>
            </form>
           
            <canvas id="myChartPareto" style="width: 200px; height: 80px;"></canvas>

            
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4 col-md-6">
    <div class="card h-100 d-flex flex-column justify-content-center align-items-center"  >
  
      <div class="card-header p-1 pt-2  ">
        <div class="d-flex align-items-center"   style=" margin-right: 50px">
          <div class="icon icon-lg icon-shape bg-gradient-success shadow-success text-center border-radius-xl mr-3"   >
            <i class="material-icons opacity-10"  style=" margin-left: 5px">description</i>
          </div>
          <div class="text-end pt-1"  >
            <p class="text-sm mb-0 text-capitalize"  >Cumulative Percentage Defects</p>
          </div>
        </div>
      </div>
      
      <hr class="dark horizontal my-0">
      <div class="card-footer p-3 d-flex flex-grow-1">
        <div class="chart-container d-flex justify-content-center align-items-center">
          <canvas id="defectsDonutChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  

</div>
</div>

<style>
  .app-card {
    transform: scale(0.965); 
    margin-top: -2rem; 
    margin-bottom: -0.5rem;
  }
  .icon {
    margin-right: 1rem; /* Adjust this value to control the spacing between the icon and text */
  }  
  
  
  
  
  
</style>

<section class="app-card">
  <h1 class="pg-title">
    <i class="fa fa-list-alt" aria-hidden="true"></i>
    {% translate "Control Report" %}
  </h1>
<div class="pg-content">
  <form id="filter-input" >
    <div class="container">
        <div class="row">
          <h3 class="h3">{% translate "Filters" %}</h3>

          <div class="col-md-3 mb-2">
            <div class="form-group">
              <label for="">User:</label>
              <select class="form-control" id="user" name="user">
                <option value="" >----</option>
                {% for val_user in users %}
                  <option value="{{ val_user.email }}">{{ val_user.email }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        

          <div class="col-md-3 mb-2">
            <div class="form-group">
              <label for="">Defect Name:</label>
              <select class="form-control" id="defect_name" name="defect_name">
                <option value="" >----</option>
                {% for val_defect in defects %}
                  <option value="{{ val_defect }}">{{ val_defect }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="col-md-3 mb-2" >
            <div class="form-group" >
              <label for="" >Product Name:</label>
              <select class="form-control" id="product_name" name="product_name" >
                <option value=""  >----</option>
                {% for val_product in products %}
                  <option  value="{{ val_product }}"  >{{ val_product }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="col-md-3 mb-2" >
            <div class="form-group" >
              <label for="" >Product Reference:</label>
              <select class="form-control" id="product_ref" name="product_ref" >
                <option value=""  >----</option>
                {% for val_product in products %}
                  <option  value="{{ val_product.serial_code }}"  >{{ val_product.serial_code }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="col-md-3 mb-2">
            <div class="form-group">
              <label for="start_date">Start Date:</label>
              <input type="date" class="form-control" id="start_date" name="start_date" autocomplete="off">
            </div>
          </div>
          <div class="col-md-3 mb-2">
            <div class="form-group">
              <label for="end_date">End Date:</label>
              <input type="date" class="form-control" id="end_date" name="end_date" autocomplete="off">
            </div>
          </div>

          <div class="col-md-3 d-flex align-items-end">
            <div class="form-group">
               <button type="submit" id="filter-input" class="btn btn-primary mr-2">Filter</button>
               <button class="btn btn-primary mr-2" onclick="exportCsv()">Export CSV</button>
               <button id="reset-button" class="btn btn-secondary">Reset</button>
            </div>
          </div>
         
        </div>
    </div>
    </form>
    <div class="table-responsive"> 
        <table class="table table-striped" id="table_serach" style="font-size : 15px;" >
            <thead>
                <tr>
                  <th>ID</th>

                    <th>Product Name</th>
                    <th>User</th>    
                    <th>Date of control </th>
                    <th>Time of control</th>
                    <th>Product Box Quantity</th>   
                    <th>Number of all Defect</th>
                    <th>Number of Good Products</th>
                    <th>Name of Defect With qte of defect</th>
                    <th>Photos</th>
                    <th>Details of control</th>
                </tr>
            </thead>
            <tbody id="table-body">
                {% for item in controls %}
                    <tr>
                      <td>{{ item.id}} </td>

                        <td>{{ item.serial_code}} </td>
                        <td>{{ item.user}} </td>
                        <td>{{ item.date_control | date:"Y-m-d" }}</td>
                        <td>{{ item.time_control|time:'H:i:s' }}</td>
                        <td>{{ item.qte}} </td>
                        <td>{{ item.defect_counts}} </td>

                        <td>{{ item.nbr_of_good_product}} </td>

                        <td>
                          <button type="button" class="btn btn-primary btn-block btn-sm btn-show-defects" data-id="{{ item.id }}" data-bs-toggle="modal" data-defects="{{ item.defects | safe  }}" data-product="{{ item.serial_code | safe  }}"><span>Show Defects</span></button>

                        </td>
                        <td>
                          <button type="button" class="btn btn-primary btn-block btn-sm btn-show-photos"  data-id="{{ item.id }}" data-bs-toggle="modal" data-product="{{ item.serial_code | safe  }}"><span>Show Photos</span></button>

                        </td>
                        <td>{{ item.details_control}} </td>
                    </tr> 
                {% endfor %}

            </tbody>
        </table>
        </div>
</div>
</section>
<div class="modal fade" id="defect-modal" tabindex="-1" aria-labelledby="defect-modal-label" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title" id="defect-modal-label">Defects</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <table id="defect-table" class="table table-striped">
      <thead>
        <tr>
          <th>Defect Name</th>
          <th>Number of Defect </th>

        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
</div>
</div>
<div class="modal fade" id="product-images-modal" tabindex="-1" role="dialog" aria-labelledby="product-images-modal-label" aria-hidden="true">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title" id="product-images-modal-label"></h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div id="product-images" class="row"></div>
  </div>
</div>
</div>
</div>



<script type="text/javascript">
  (function(d, m){
      var kommunicateSettings = 
          {"appId":"2f714a2c1c0ad786c71982711e10c80a2","popupWidget":true,"automaticChatOpenOnNavigation":true};
      var s = document.createElement("script"); s.type = "text/javascript"; s.async = true;
      s.src = "https://widget.kommunicate.io/v2/kommunicate.app";
      var h = document.getElementsByTagName("head")[0]; h.appendChild(s);
      window.kommunicate = m; m._globals = kommunicateSettings;
  })(document, window.kommunicate || {});
/* NOTE : Use web server to view HTML files as real-time update will not work if you directly open the HTML file in the browser. */
</script>


<!--section for graph control filter-->
<script>
$(document).on("click", ".btn-show-defects", function () {
var control_id = $(this).data("id");
var defects = $(this).data("defects");
var product = $(this).data("product");

var tableBody = $("#defect-table tbody");
console.log(defects);
console.log(control_id);
console.log(product);

console.log(typeof defects);
var defectsArray = [];

if ( defects.length > 0) {
  defectsArray = defects.replace(/[[\]']/g,'').split(',');
}

//var defectsArray = JSON.parse(defects);

console.log(defectsArray);
console.log(typeof defectsArray);
tableBody.empty();

$.ajax({
  url: '{% url 'qualifeed:logs' request.team.slug%}',
  data: {
      'show_control_id': control_id,
      'show_defect_id': defectsArray,
      'show_product_id': product,
  },
  success: function(data) {
    console.log(data.defect_counts);
    var defect_table = data.defect_counts;
      // update the table cells with the number of defects
      if (Object.keys(defect_table).length > 0) {
        for (var defect_name in defect_table) {
          if (defect_table.hasOwnProperty(defect_name)) {
            var defect_count = defect_table[defect_name];
            tableBody.append('<tr><td>' + defect_name + '</td><td>' + defect_count + '</td></tr>');
          }
        }
      } else {
        tableBody.append('<tr><td colspan="2">No defects found</td></tr>');
      }
    $('#defect-modal').modal('show'); // move this line inside the success function
  }
});

});

$(document).on("click", ".btn-show-photos", function () {
var control_id = $(this).data("id");

var productId = $(this).data('product');
var modalTitle = $(this).text();
var modal = $('#product-images-modal');
var modalLabel = $('#product-images-modal-label');
var modalBody = $('#product-images');
modalLabel.text(modalTitle);
modal.modal('show');
console.log(productId);
$.ajax({
  url: '{% url 'qualifeed:logs' request.team.slug%}',
  data: {
    'control_id_image': control_id
  },
  success: function(response) {
    console.log(response);
    modalBody.empty();
    if (response.image_urls.length === 0) {
      modalBody.append('<p>No photos returned in Control for this product.</p>');
    } else {
      $.each(response.image_urls, function(index, imageUrl) {
        modalBody.append('<div class="col-md-3"><a href="' + imageUrl + '" data-toggle="lightbox" data-gallery="product-gallery"><img src="' + imageUrl + '" class="img-fluid"></a></div>');
      });
      // Activate the lightbox plugin for the gallery
    }
  }
});
});
$('#product-images-modal .close').click(function() {
$('#product-images-modal').modal('hide');
});


</script>
<div class="modal fade" id="defectsModal" tabindex="-1" role="dialog" aria-labelledby="defectsModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title" id="defectsModalLabel">List of Defects</h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <ul>
      {% for item in defects %}
        <li>{{ item }}</li>
      {% endfor %}
    </ul>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
  </div>
</div>
</div>
</div>



<div class="container-fluid py-4">
  <div class="row mb-4">
  
          
  <div class="col-lg-8 col-md-6 mb-md-0 mb-4">
  <div class="card">
  <div class="card-header pb-0">
    <h1 class="pg-title">
      <i class="fa fa-bar-chart" aria-hidden="true"></i>
      {% translate "Control filter" %}
    </h1>
      
         
      </div>
      <div class="pg-content">
  
        <div class="container">
          <div class="row">
            <div class="col-lg-6 col-7">
              <h6 style="margin-top : 15px;" >Filter</h6>
              <p class="text-sm mb-0"></div>  
                  
              <form id="filter-form">
                {% csrf_token %}
                <div class="row">
                  <div class="col-md-3 mb-2">
                    <div class="form-group">
                      <label for="post">Job:</label>
                      <select class="form-control" id="post" name="post">
                        <option value="">----</option>
                        {% for item in post_list %}
                          <option value="{{ item }}">{{ item }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="col-md-3 mb-2">
                    <div class="form-group">
                      <label for="user_chart">User:</label>
                      <select class="form-control" id="user_chart" name="user_chart">
                        <option value="">----</option>
                        {% for val_chart_user in users %}
                          <option value="{{ val_chart_user.email }}">{{ val_chart_user.email }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
  
                  <div class="col-md-3 mb-2">
                    <div class="form-group">
                      <label for="product_chart">Product Name:</label>
                      <select class="form-control" id="product_chart" name="product_chart">
                        <option value="">----</option>
                        {% for val_char_product in products %}
                          <option value="{{ val_char_product }}">{{ val_char_product }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
  
                  <div class="col-md-3 mb-2">
                    <div class="form-group">
                      <label for="product_chart">Product Reference:</label>
                      <select class="form-control" id="product_ref_chart" name="product_ref_chart">
                        <option value="">----</option>
                        {% for val_char_product in products %}
                          <option value="{{ val_char_product.serial_code }}">{{ val_char_product.serial_code }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-md-3 mb-2">
                    <div class="form-group">
                      <label for="defect_chart">Defect Name:</label>
                      <select class="form-control" id="defect_chart" name="defect_chart">
                        <option value="">----</option>
                        {% for val_defect_chart in defects %}
                          <option value="{{ val_defect_chart }}">{{ val_defect_chart }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
  
                  <div class="col-md-3 mb-2">
                    <div class="form-group">
                      <label for="start_date_chart">Start Date:</label>
                      <input type="date" class="form-control" id="start_date_chart" name="start_date_chart" autocomplete="off">
                    </div>
                  </div>
                  <div class="col-md-3 mb-2">
                    <div class="form-group">
                      <label for="end_date">End Date:</label>
                      <input type="date" class="form-control" id="end_date_chart" name="end_date_chart" autocomplete="off">
                    </div>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <div class="form-group">
                      <button type="button" class="btn btn-primary mr-3" id="filter-button"> Filter</button>
                    </div>
                    <div class="form-group">
  
                      <button type="button" class="btn btn-secondary" id="reset-chart" style="display: inline-block; margin-left: 15px">Reset</button>
                    </div>
                  </div>
                </div>
              </form>
              <canvas id="myChart"></canvas>
              
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-6">
      <div class="card h-100">
      <div class="card-header pb-0">
        <h6>Overview</h6>
        <p class="text-sm">
          <i class="fa fa-check text-info" aria-hidden="true"></i>
          <span class="font-weight-bold ms-1">{{control_count}} Controls done</span> this month
        
        </p>
      </div>
      <div class="card-body p-3">
        <div class="timeline timeline-one-side">
          <div class="timeline-block mb-3">
            <span class="timeline-step">
              <i class="material-icons text-success text-gradient">notifications</i>
            </span>
            <div class="timeline-content">
              <h6 class="text-dark text-sm font-weight-bold mb-0">Last Control on: 
              </h6>
              <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ last_updated_control.updated_at }}</p>
            </div>
          </div>
          <div class="timeline-block mb-3">
            <span class="timeline-step">
              <i class="material-icons text-danger text-gradient">code</i>
            </span>
            <div class="timeline-content">
              <h6 class="text-dark text-sm font-weight-bold mb-0">Last Defect Added</h6>
              <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ last_defect }}</p>
            </div>
          </div>
          <div class="timeline-block mb-3">
            <span class="timeline-step">
              <i class="material-icons text-info text-gradient">person</i>
            </span>
      
           <div class="timeline-content">
        <h6 class="text-dark text-sm font-weight-bold mb-0">Last Controller</h6>
      
      
          <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">
            {{ last_user_control_email}} on {{  last_control.date_control |date:"M d, Y" }}
          </p>
      
       <!--
      
       <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ last_user_control_email }}</p>
      
       -->
      </div>
          </div>
          <div class="timeline-block mb-3">
            <span class="timeline-step">
              <i class="material-icons text-warning text-gradient">snooze</i>
            </span>
            <div class="timeline-content">
              <h6 class="text-dark text-sm font-weight-bold mb-0">Last Reparation</h6>
              <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ latest_repair }}</p>
            </div>
          </div>
         <!--
      
          <div class="timeline-block mb-3">
            <span class="timeline-step">
              <i class="material-icons text-primary text-gradient">key</i>
            </span>
            <div class="timeline-content">
              <h6 class="text-dark text-sm font-weight-bold mb-0">Unlock packages for development</h6>
              <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">18 DEC 4:54 AM</p>
            </div>
          </div>-->
          <div class="timeline-block mb-3">
            <span class="timeline-step">
              <i class="material-icons text-warning text-gradient">today</i>
            </span>
            <div class="timeline-content">
              <h6 class="text-dark text-sm font-weight-bold mb-0">Last product added for Control </h6>
              <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ last_product }}</p>
            </div>
          </div>
          
          <div class="timeline-block mb-3">
            <span class="timeline-step">
              <i class="material-icons text-primary text-gradient">show_chart</i>
            </span>
          
            <div class="timeline-content">
              <h6 class="text-dark text-sm font-weight-bold mb-0">Last Control and its related defects and products:</h6>
  
              <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">
              
                <tr> <br>
                        {% for control in last_three_controls_with_defects %}
                      
                        <label>  Â» </label>     <label>Control id: </label>  <td>{{ control.id }} </td><label>has {{ control.defect_id.count }} <label>defect(s)</label></label>  <label>on </label>  <td>{{ control.date_control }}</td><label> on </label> <td>{{ control.time_control }}</td> <label> done by </label> <td>{{ control.user.email }}</td> <label>.</label>
                         
                       
                      </tr> </br>
                      {% endfor %}
                   
      
                
  </p>
  
            </div>
          </div>
   
      
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
              const user = document.getElementById('user');
              const defect_name = document.getElementById('defect_name');
              const product_name = document.getElementById('product_name');
              const product_ref = document.getElementById('product_ref');

              const start_date = document.getElementById('start_date');
              const end_date = document.getElementById('end_date');
              const filterForm = document.getElementById('filter-input');
              
              filterForm.addEventListener('submit', function(event){
                const tableBody = document.getElementById('table-body');
  
                event.preventDefault();
                const formData = {
                  'user':user.value,
                  'product_name':product_name.value,
                  'product_ref':product_ref.value,
                  'defect_name': defect_name.value,
                  'start_date':start_date.value,
                  'end_date':end_date.value
                }
                console.log(formData);
                $.ajax({
                  url: '{% url 'qualifeed:logs' request.team.slug%}',
                  data: {
                    'formData': formData
                  },
                  success: function(data){
                    $('#table_serach').DataTable().destroy();

                    // Re-initialize the plugin with the updated table content
                    tableBody.innerHTML = '';
                    console.log(data.controls_list);
                    data = data.controls_list;
                   for (var i = 0; i < data.length; i++) {
                      var row = document.createElement('tr');

                      var idCell = document.createElement('td');
                      idCell.innerText = data[i].id;
                      row.appendChild(idCell);

                      var serialCodeCell = document.createElement('td');
                      serialCodeCell.innerText = data[i].serial_code__product_name;
                      row.appendChild(serialCodeCell);
              
                      var usernameCell = document.createElement('td');
                      usernameCell.innerText = data[i].user__username;
                      row.appendChild(usernameCell);
              
                      var dateControlCell = document.createElement('td');
                      dateControlCell.innerText = data[i].date_control;
                      row.appendChild(dateControlCell);
              
                      var timeControlCell = document.createElement('td');
                      timeControlCell.innerText = data[i].time_control;
                      row.appendChild(timeControlCell);
            
                      var QteBoxProductCell = document.createElement('td');
                      QteBoxProductCell.innerText = data[i].qte;
                      row.appendChild(QteBoxProductCell);
                      

                      var NumberOfAllDefectsCell = document.createElement('td');
                      NumberOfAllDefectsCell.innerText = data[i].defect_counts;
                      row.appendChild(NumberOfAllDefectsCell);

                      var NumberOfGoodProductCell = document.createElement('td');
                      if (data[i].nbr_of_good_product) {
                        NumberOfGoodProductCell.innerText = data[i].nbr_of_good_product;
                      } else {
                        NumberOfGoodProductCell.innerText = "None";
                      }
                      row.appendChild(NumberOfGoodProductCell);


                      var defectsCell = document.createElement('td');
                      var defectsButton = document.createElement('button');
                      defectsButton.type = 'button';
                      defectsButton.classList.add('btn', 'btn-primary', 'btn-block', 'btn-sm', 'btn-show-defects');
                      defectsButton.setAttribute('data-id', data[i].id);
                      defectsButton.setAttribute('data-defects', data[i].defects);
                      defectsButton.setAttribute('data-product', data[i].serial_code__product_name);
                      defectsButton.innerHTML = '<span>Show Defects</span>';
                      defectsCell.appendChild(defectsButton);
                      row.appendChild(defectsCell);

                      var photosCell = document.createElement('td');
                      var photosButton = document.createElement('button');
                      photosButton.type = 'button';
                      photosButton.classList.add('btn', 'btn-primary', 'btn-block', 'btn-sm', 'btn-show-photos');
                      photosButton.setAttribute('data-id', data[i].id);
                      photosButton.setAttribute('data-product', data[i].serial_code);
                      photosButton.innerHTML = '<span>Show Photos</span>';
                      photosCell.appendChild(photosButton);
                      row.appendChild(photosCell);
              
                      var detailsControlCell = document.createElement('td');
                      detailsControlCell.innerText = data[i].details_control;
                      row.appendChild(detailsControlCell);

                      tableBody.appendChild(row);
                    }
                    $('#table_serach').DataTable();
                  },
                  error: (xhr, status, error) => {
                    console.error(error);
                  }
                  
                });
                
              });
              const resetButton = document.getElementById('reset-button');
              console.log(resetButton.value);

              resetButton.addEventListener('click', function() {
                event.preventDefault();
                const filterForm = document.getElementById('filter-input');
                filterForm.reset(); // resets all input fields in the form to their default values
                $.ajax({
                  url: '{% url 'qualifeed:logs' request.team.slug%}',
                  data: {
                    'reset': 'reset'
                  },
                  success: function(data){
                    $('#table_serach').DataTable().destroy();
 
                    data = data.controls_dis;    
                    console.log(data); 
                    const tableBody = document.getElementById('table-body');
                    
                    tableBody.innerHTML = '';         
                    for (var i = 0; i < data.length; i++) {

                    
                     var row = document.createElement('tr');
                    
                     var idCell = document.createElement('td');
                     idCell.innerText = data[i].id;
                     row.appendChild(idCell);

                     var serialCodeCell = document.createElement('td');
                     serialCodeCell.innerText = data[i].serial_code__product_name;
                     row.appendChild(serialCodeCell);
                    
                     var usernameCell = document.createElement('td');
                     usernameCell.innerText = data[i].user__username;
                     row.appendChild(usernameCell);
                    
                     var dateControlCell = document.createElement('td');
                     dateControlCell.innerText = data[i].date_control;
                     row.appendChild(dateControlCell);
                    
                     var timeControlCell = document.createElement('td');
                     timeControlCell.innerText = data[i].time_control;
                     row.appendChild(timeControlCell);

                     var QteBoxProductCell = document.createElement('td');
                     QteBoxProductCell.innerText = data[i].qte;
                     row.appendChild(QteBoxProductCell);;

                     var NumberOfAllDefectsCell = document.createElement('td');
                     NumberOfAllDefectsCell.innerText = data[i].defect_counts;
                     row.appendChild(NumberOfAllDefectsCell);

                     var NumberOfGoodProductCell = document.createElement('td');
                     if (data[i].nbr_of_good_product) {
                       NumberOfGoodProductCell.innerText = data[i].nbr_of_good_product;
                     } else {
                       NumberOfGoodProductCell.innerText = "None";
                     }
                     row.appendChild(NumberOfGoodProductCell);

                     var defectsCell = document.createElement('td');
                      var defectsButton = document.createElement('button');
                      defectsButton.type = 'button';
                      defectsButton.classList.add('btn', 'btn-primary', 'btn-block', 'btn-sm', 'btn-show-defects');
                      defectsButton.setAttribute('data-id', data[i].id);
                      defectsButton.setAttribute('data-defects', data[i].defects);
                      defectsButton.setAttribute('data-product', data[i].serial_code__product_name);
                      defectsButton.innerHTML = '<span>Show Defects</span>';
                      defectsCell.appendChild(defectsButton);
                      row.appendChild(defectsCell);
                    
                      var photosCell = document.createElement('td');
                      var photosButton = document.createElement('button');
                      photosButton.type = 'button';
                      photosButton.classList.add('btn', 'btn-primary', 'btn-block', 'btn-sm', 'btn-show-photos');
                      photosButton.setAttribute('data-id', data[i].id);
                      photosButton.setAttribute('data-product', data[i].serial_code);
                      photosButton.innerHTML = '<span>Show Photos</span>';
                      photosCell.appendChild(photosButton);
                      row.appendChild(photosCell);

                     var detailsControlCell = document.createElement('td');
                     detailsControlCell.innerText = data[i].details_control;
                     row.appendChild(detailsControlCell);
                    
                     tableBody.appendChild(row);
                   } 

                   // Re-initialize the plugin with the updated table content
                   $('#table_serach').DataTable();
                 }
               });
               
              });
              </script>


            <!-- code for Control filter graph-->

              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


              <script>

            $(document).ready(function() {
              var ctx = document.getElementById('myChart').getContext('2d');
              var chart = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: [],
                  datasets: [{
                    label: 'Defected',
                    data: [],
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                  }]
                },
                options: {
                  scales: {
                    yAxes: [{
                      ticks: {
                        beginAtZero: true
                      }
                    }]
                  }
                }
              });
              $('#reset-chart').on('click', function(event) {
                $('#reset-chart').val('');
                $('#start_date_chart').val('');
                $('#end_date_chart').val('');
                $('#user_chart').val('');
                $('#post').val('');
                $('#product_chart').val('');
                $('#defect_chart').val('');
                $('#defect_chart').val('');
                $('#product_ref_chart').val('');

                chart.data.labels = [];
                chart.data.datasets.forEach((dataset) => {
                  dataset.data = [];
                });
                chart.update();
                });
              
              $('#filter-button').on('click', function(event) {
                var post = $('#post').val();
                var start_date = $('#start_date_chart').val();
                var end_date = $('#end_date_chart').val();
                var user = $('#user_chart').val();
                var product = $('#product_chart').val();
                var defect = $('#defect_chart').val();
                var product_ref_chart =  $('#product_ref_chart').val();
                
                $.ajax({
                  url: '{% url 'qualifeed:logs' request.team.slug%}',
                  data: {
                    'user_chart':user,
                    'poste': post,
                    'start_date_chart': start_date,
                    'end_date_chart': end_date,
                    'product_chart':product,
                    'defect_chart':defect,
                    'product_ref_chart':product_ref_chart

                  },
                  success: function(data) {
                    console.log(data);
                    chart.config.type = 'line';
                    chart.data.labels = data.labels;
                    chart.data.datasets[0].data = data.data;
                    chart.update();
                  }
                });
              });
              
            });  

          </script>
<script>
  
    $(document).ready(function () {
        $('#table_serach').DataTable();
        
    });
</script>
<script>
  // Get the current URL
  var currentUrl = window.location.href;

  // Extract the team slug from the URL
  var teamSlug = currentUrl.split('/')[4]; 
  function exportCsv() {
    // Get the filter input values
    var user = $('#user').val();
    var defect_name = $('#defect_name').val();
    var product_name = $('#product_name').val();
    var start_date = $('#start_date').val();
    var end_date = $('#end_date').val();
    console.log(teamSlug);
    // Construct the URL for the CSV export
    var url = 'https://qualifeed.io/a/dev/qualifeed/ControlGetApi/?user__email=' + encodeURIComponent(user) +
    '&defect_id__defect_name=' + defect_name.replace(/,/g, " ") + 
    '&serial_code__product_name=' + product_name.replace(/ /g, "+") +
    '&team__name=' + teamSlug.replace(/ /g, "+") +
    '&start_date=' + start_date +
    '&end_date=' + end_date;

              
    console.log(url)
    // Send an AJAX GET request to the backend Django view
    $.ajax({
      url: url,
      type: 'GET',
     
      success: function(data) {
      // Create a link element with the CSV data and trigger a download
      // Convert the data to CSV format
      console.log(url);
      console.log(data);
     
      if (data && data.length > 0) {
        var csv = 'data:text/csv;charset=utf-8,';
        console.log(data);
       
        csv += Object.keys(data[0]).join(',') + '\n';
        data.forEach(function(row) {
            // Combine image URLs into a comma-separated string
            var images = row.images.map(function(image) {
              return image.photo_control;
            }).join(' ');

            // Update row object with image URLs string
            row.images = images;
           row.defect_id = row.defect_id.join(' ');
            csv += Object.values(row).join(',') + '\n';
        });
        
    
        // Create a link to download the CSV file
        var link = document.createElement('a');
        link.setAttribute('href', encodeURI(csv));
        link.setAttribute('download', 'controls_list.csv');
        document.body.appendChild(link);
        link.click();
    } else {
        
        console.log('No results found.');
        console.log(data.results);
        // Create a link to download the CSV file
        var csv = 'data:text/csv;charset=utf-8,';
        var link = document.createElement('a');
        link.setAttribute('href', encodeURI(csv));
        link.setAttribute('download', 'controls_list.csv');
        document.body.appendChild(link);
        link.click();
    }
      },
      error: function() {
        alert('Error exporting CSV');
      }
    });
  }
</script>

<script>

  var defectsPareto = {{ defectsPareto|safe }};
  var defectNames = [];
  var numberDefects = [];
  defectsPareto.forEach(function(defect) {
    if (defect.number_defect > 0) { 
      defectNames.push(defect.defect_name);
      numberDefects.push(defect.number_defect);
  }
});


  // Sort the defects by number of defects in descending order
  var sortedIndexes = numberDefects.map(function(_, i) { return i; })
      .sort(function(a, b) { return numberDefects[b] - numberDefects[a]; });
  
  defectNames = sortedIndexes.map(function(index) { return defectNames[index]; });
  numberDefects = sortedIndexes.map(function(index) { return numberDefects[index]; });
  
  // Calculate the cumulative percentage
  var total = numberDefects.reduce(function(sum, value) { return sum + value; }, 0);
  var cumulativePercentage = numberDefects.map(function(value, index) {
      return (value / total * 100).toFixed(2);
  });
  
  // Create the Pareto chart
  var ctx = document.getElementById('myChartPareto').getContext('2d');
  var paretoChart = new Chart(ctx, {
      type: 'bar',
      data: {
          labels: defectNames,
          datasets: [{
              label: 'Number of Defects',
              data: numberDefects,
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
          }]
      },
      options: {
          scales: {
              y: {
                  beginAtZero: true,
                  max: Math.ceil(Math.max(...numberDefects) * 1.2),
                  min: 0,
                  stepSize: 20,
                  display: true,
                  position: 'left',
              }
          }
      }
  });

  // Update the chart with new data
     paretoChart.data.labels = defectNames;
     paretoChart.data.datasets[0].data = numberDefects;
     paretoChart.options.scales.y.max = Math.ceil(Math.max(...numberDefects) * 1.2);
     paretoChart.update(); // Call update() method to apply changes to the chart



  $('#reset-chart-pareto').on('click', function(event) {

    var start_date = $('#start_date_chart_pareto').val('');
    var end_date = $('#end_date_chart_pareto').val('');
    var user = $('#user_chart_pareto').val('');
    var product = $('#product_chart_pareto').val('');
  // Sort the defects by number of defects in descending order
  var sortedIndexes = numberDefects.map(function(_, i) { return i; })
      .sort(function(a, b) { return numberDefects[b] - numberDefects[a]; });
  
  defectNames = sortedIndexes.map(function(index) { return defectNames[index]; });
  numberDefects = sortedIndexes.map(function(index) { return numberDefects[index]; });
  
  // Calculate the cumulative percentage
  var total = numberDefects.reduce(function(sum, value) { return sum + value; }, 0);
  var cumulativePercentage = numberDefects.map(function(value, index) {
      return (value / total * 100).toFixed(2);
  });
    // Reset chart data and configuration options
    paretoChart.data.labels = defectNames;
    paretoChart.data.datasets[0].data = numberDefects;
    // Update the chart with new data
    paretoChart.data.labels = defectNames;
    paretoChart.data.datasets[0].data = numberDefects;
    paretoChart.options.scales.y.max = Math.ceil(Math.max(...numberDefects) * 1.2);
    paretoChart.update();
  });
  
$('#filter-button-pareto').on('click', function(event) {

    var start_date = $('#start_date_chart_pareto').val();
    var end_date = $('#end_date_chart_pareto').val();
    var user = $('#user_chart_pareto').val();
    var product = $('#product_chart_pareto').val();

    $.ajax({
        url: '{% url 'qualifeed:logs' request.team.slug%}',
        data: {
            'user_pareto_chart': user,
            'start_date_pareto_chart': start_date,
            'end_date_pareto_chart': end_date,
            'product_pareto_chart': product,

        },
        success: function(data) {
            console.log(data);
            var defectNames = [];
            var numberDefects = [];
            data.defectsPareto.forEach(function(defect) {
                if (defect.number_defect > 0) { 
                    defectNames.push(defect.defect_name);
                    numberDefects.push(defect.number_defect);
                }
            });

            // Sort the defects by number of defects in descending order
            var sortedIndexes = numberDefects.map(function(_, i) { return i; })
                .sort(function(a, b) { return numberDefects[b] - numberDefects[a]; });

            defectNames = sortedIndexes.map(function(index) { return defectNames[index]; });
            numberDefects = sortedIndexes.map(function(index) { return numberDefects[index]; });

            // Calculate the cumulative percentage
            var total = numberDefects.reduce(function(sum, value) { return sum + value; }, 0);
            var cumulativePercentage = numberDefects.map(function(value, index) {
                return (value / total * 100).toFixed(2);
            });

            paretoChart.config.type = 'bar';
            paretoChart.data.datasets[0].data = numberDefects;
            paretoChart.data.labels = defectNames; 
            paretoChart.data.data = cumulativePercentage;

            // Update the chart with new data
            paretoChart.data.labels = defectNames;
            paretoChart.data.datasets[0].data = numberDefects;
            paretoChart.options.scales.y.max = Math.ceil(Math.max(...numberDefects) * 1.2);
            paretoChart.update();
            
            
        }
    });
});

  

</script>

<script>
  var defectsPareto = {{defectsPareto|safe}};
  var defectNames = [];
  var numberDefects = [];
  defectsPareto.forEach(function(defect) {
    if (defect.number_defect > 0) { 
      defectNames.push(defect.defect_name);
      numberDefects.push(defect.number_defect);
    }
  });
  
  var total = numberDefects.reduce(function(sum, value) { return sum + value; }, 0);
  var percentageData = numberDefects.map(function(value) {
    return (value / total * 100).toFixed(2);
  });
  
  // Create the donut chart
  var ctx = document.getElementById('defectsDonutChart').getContext('2d');
  var defectsDonutChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: defectNames,
      datasets: [{
        data: percentageData,
        backgroundColor: ['rgba(75, 192, 192, 0.8)', 'rgba(255, 99, 132, 0.8)', 'rgba(255, 205, 86, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)'], // Customize the colors as needed
        borderColor: 'rgba(255, 255, 255, 1)', // Customize the border color as needed
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
  
  </script>
  


{% endblock %}